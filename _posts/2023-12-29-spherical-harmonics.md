---
layout: post
title:  "Spherical Harmonics Lighting"
date:   2023-12-25
excerpt: "The common mathematics methods in rendering."
tag:
- Computer Graphics 
graphics: true
feature: https://github.com/OneSilverBullet/SilverGamer.GitHub.io/blob/gh-pages/_img/graph/head.png

---

## 1. The Spherical Harmonics Basis

### 1.1 Spherical Harmonics Mathemactics

Harmonics functions is a solution of Laplace function, which is a series of orthogonal basises.

The relation between polar coordinates and cartesian coordinate is as follows.

$$s=(x,y,z)=(sinθcosφ, sinθsinφ, cosθ)$$


## 1.3 Projection from Cubemap

Irradiance map is an essential part in Image based Rendering. To reduce the storage cost, we can project the irradiance map to a series of spherical harmonics parameters. In the real-time applictaion, we can rebuild the irradiance based on the harmonics parameters. Analytic solutions exist for the first several orders of spherical harmonics.




## 2. The Global Illumination in Modern Shading Pipeline 

In this chapter, we will discuss about how the global illumination can be used in shading pipeline. As we all know, different shading models have different BRDF functions, which means these shaders' calculation are different with each other. To embed the global illumination in the shading pipeline, we separate the shading process into two parts in architecture view: direct lighting and environment lighting.

* Direcet Lighting: the direct shading process contains the direct diffuse and direct specular.
* Environment Lighting: the indirect shading process contains the environment diffuse and environment specular.
    * the environment diffuse generated by the lights probe in game engine.
    * the environment specular generated by the reflection probes, SSR, reflection planar probes.

In the custom game engine, we can design the shader architecture as follows. We focus on the environment diffuse calculation in this blog.

<figure>
    <a href="https://raw.githubusercontent.com/OneSilverBullet/SilverGamer.GitHub.io/gh-pages/_img/graph/sp.png"><img src="https://raw.githubusercontent.com/OneSilverBullet/SilverGamer.GitHub.io/gh-pages/_img/graph/sp.png" align="center"></a>
    <figcaption>the shading pipeline.</figcaption>
</figure>

### 2.1 The Light Probes

The spherical harmonics are suitable for storing the low-frequency information. Hence, the diffuse lighting information with low-frequency can be projectted into the spherical harmonics. 

In modern game engine, we place multiple probes around the scene. Each light probe stores the spherical harmonics parameters, which are the projection of the surrounding diffuse lighting information(cubemaps/samples). The diffuse lighting information can be gained through two ways:
* Cubemaps: Take pictures in six directions of cubemaps from the probe view.
* Samples: Each texel in cubemap can be recognized as a sample result in target direction. We can send the direction to a off-line ray tracer to get the rendering result.

The process of calculating spherical harmonics for each light probes is called baking. 

After baking, to shading a fragment, we interpolate the spherical harmonics value based on the position of current fragment. The process:

(1) We interpolate the sh values in the light porbes volume based on the normal vector and world space position of current fragment.

(2) This sh value can be encapsulated in the structure to send to the shading pipeline.

(3) Furthermore, we can get the indirect environment diffuse by multiplicating of sh values and albedo. 

Albedo refers to the diffuse color of a material or surface, which is **the color that is scattered equally in all directions when light hits it**.









<figure>
    <a href="https://raw.githubusercontent.com/OneSilverBullet/SilverGamer.GitHub.io/gh-pages/_img/graph/fd.png"><img src="https://raw.githubusercontent.com/OneSilverBullet/SilverGamer.GitHub.io/gh-pages/_img/graph/fd.png" align="center"></a>
    <figcaption>the function diagram.</figcaption>
</figure>
